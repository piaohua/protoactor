# majiang

Go语言麻将服务器实现

Backend implementation of server in golang 


# usage

cd bin
./ctrl build
./ctrun run

# protocol
protobuf

# document

协议数据打包：
handerLen + protoLen + dataLen + data

handerLen uint32 = 1 : 包头长度1byte(包序)
protoLen uint32  = 4 : 协议号长度4(大端序)
dataLen uint32 = 4 : 数据长度4(大端序)
data uint32 = dataLen : 数据

包序算法：index++; index = index % 256

server port:7001

//牌值定义:
高四位表示色值(0:万,1:条,2:饼)，
低四位表示1-9的牌值
如:0x09 = 九万

//掩码值定义(TODO:可以修改调整)
// 碰杠胡掩码,用32位每位代表不同的状态
DRAW      uint32 = 0      // 摸牌
DISCARD   uint32 = 1      // 打牌
PENG      uint32 = 2 << 0 // 碰
MING_KONG uint32 = 2 << 1 // 明杠
AN_KONG   uint32 = 2 << 2 // 暗杠
BU_KONG   uint32 = 2 << 3 // 补杠
KONG      uint32 = 2 << 4 // 杠(代表广义的杠)
CHOW      uint32 = 2 << 5 // 吃
HU        uint32 = 2 << 6 // 胡(代表广义的胡)

//胡牌方式
ZIMO           uint32 = 2 << 8  // 自摸
HEIMO          uint32 = 2 << 9  // 黑摸
RUANMO         uint32 = 2 << 10 // 软摸
PAOHU          uint32 = 2 << 11 // 炮胡,也叫放冲
QIANG_GANG     uint32 = 2 << 12 // 抢杠,其他家胡你补杠那张牌
REPAO          uint32 = 2 << 13 // 热炮,杠后出牌被胡
HU_KONG_FLOWER uint32 = 2 << 14 // 杠上开花,杠完牌抓到的第一张牌自摸了
TIAN_HU        uint32 = 2 << 15 // 天胡
DI_HU          uint32 = 2 << 16 // 地胡

//胡牌类型
HU_PING          uint32 = 2 << 17 // 平胡


玩法规则(TODO:修改完善):

游戏简介：
    一赖到底有两个特点：
    1、笑：仙桃人讲的点笑、回头笑、闷笑（是指麻将中的：明杠、补杠、暗杠）
    2、晃：胡牌者会被换下，让其他人上。所以一赖到底的游戏可以多人参与。
    3、一赖到底牌型简单，有赖子，胡牌和笑牌都有翻倍
    4、胡牌牌型：(108,筒、条、万各36),胡牌者的牌型必须具备下列牌型之一:
        A.11,123,123,123,123
        B.11,123,123,123,111
        C.11,123,123,111,111
        D.11,123,111,111,111
        E.11,111,111,111,111
    5、 规则：
    6、 庄  家： 四人游戏时谁胡牌谁当庄家,多人游戏时胡牌者对家当庄,庄家流局则继续当庄家
    7、 翻赖子：所有玩家牌起完后,翻第一张牌确定赖子,翻出的牌是一(万/条/筒)，那么二(万/条/筒)为赖子。
    8、 碰  杠：只能碰牌，不能吃。有明杠、补杠、暗杠。
    9、 无海底：摸完所有的牌.最后一手牌摸完后也要打出。
    10、荒  庄：即使荒庄，明杠、补杠、暗杠的分数同样需要计算。
    11、朝  天：赖子皮翻出来后,就不在牌里出现了,比如翻三万,那一局就剩3张三万.谁起
                到3张三万就算自摸朝天，等同于暗杠。起到2张三万，别人打出来一个三万碰就等同于点笑。
    12、胡牌方式：
        1.赖 子：胡牌时牌中只允许有一个籁子，多的籁子必须杠下来。只要有一个玩家杠赖子后，
                 所有玩家都只能自摸。
        2.硬 胡：无赖子或者赖子和在句里面的胡牌牌型。
        3.硬 摸：又称黑摸，硬胡自摸。手上有四个赖子杠3个后，手上还有一个赖子自摸的软摸算是硬摸。
        4.放 炮：只有硬胡牌型才能胡放炮，放炮有一炮多响。
        5.软 摸：有一个赖子的自摸。
        6.抢 杠：补杠时有被抢的可能，如补杠3万时，有人胡3万为抢杠，硬胡的牌型才能抢杠。
        7.热 铳：明杠、暗杠、补杠后，打出的那张牌放炮就是热铳。硬胡的牌型才能胡热铳。
    13、番种及分数：
        一赖到底的胡牌和杠牌是分开结算的。玩家杠赖子后，胡牌和杠牌都需要算翻数。
        1.胡 牌：胡牌1分；
        2.杠 牌：明杠1分、补杠1分、暗杠2分，点朝天1分，自摸朝天2分；
        3.算 翻：赖子杠*2、自摸*2、硬胡*2。

仙桃麻将规则技巧： 
1、牌型:自摸和接冲,自摸算两倍(每家都给钱),点冲算一倍(点冲者给钱)
2、“买马”及其规则：
    “买马”是四个人在玩，有多余的人在旁无聊想参与进来，
    就在起完牌后随便拿一张牌（一般在最后几顿牌），以庄家为起点，
    按所拿牌面数字确定你买在谁身上了，然后跟着那个人一起输赢，
    当然倍数可能不一样。
3、“笑系列”以及规则：
   暗扛--“暗笑”：手起或者中途起到四张一样的牌。算钱倍数与自摸相同都是两倍。
                （“暗笑”可以当时也可以过几圈再“笑”） 
   补扛--“自笑”：起先将某一张牌“蹦”起来，后又自己将这张牌的绝张抓回来。算钱倍数为一倍，但3家都得开钱。
                （“自笑”只能当时“笑”） 
   明扛--“点笑”：手起一扛，被人将这张牌的绝张打出，则为“点笑”。算钱与点冲一致。


拿牌规则：第一次掷确定第二位掷骰子的参与者,庄家掷点
例如：庄家为1，按逆时针方向，庄为东
骰子点数   下次掷骰子的方位
5、9       东
2、6、10   南
3、7、11   西
4、8、12   北


算番：
胡牌方式分
1、软摸1分
2、黑摸2分
3、炮胡1分
4、抢杠2分
5、热杠2分
5、杠上花2分
6、天胡3分
7、地胡3分
(注：多个时只取最高的,顺序7~1)

胡牌分或牌型分
1、平胡1分
(注：多个时只取最高的,顺序7~1)

扔赖分
1、扔赖数量 * 2倍

收取方式：
A分 = (胡牌方式 + 牌型分 + 扔赖分) * 底分
1、庄家自摸收三家 * 1倍A分
2、闲家自摸收三家 * 1倍A分
3、庄家炮胡收一家 * 1倍A分（收放炮玩家）
4、闲家炮胡收一家 * 1倍A分（收放炮玩家）

杠牌分
B分 = 杠牌分
1、明杠1分 * 1倍(放杠玩家出)
2、暗杠2分 * 2倍(收三家)
3、补杠1分 * 1倍(收三家)

总分 = A + B

TODO 前端展示方式调整,暂时按再有协议显示
